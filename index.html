<script src="db.js"></script>
<script>
  // ================= é…ç½®åŒº =================
  const FEATURED_BRANDS = [
    "Creed",
    "Dior",
    "Chanel",
    "Tom Ford",
    "Yves Saint Laurent",
    "Louis Vuitton",
    "Gucci",
    "Burberry",
    "Versace",
    "Carolina Herrera",
    "Giorgio Armani",
    "Prada",
    "Valentino",
    "Maison Francis Kurkdjian",
    "Parfums de Marly",
    "Le Labo",
    "Byredo",
    "Kilian",
    "Jo Malone",
  ];

  // ================= çŠ¶æ€å˜é‡ =================
  let cartItems = [];
  let currentPage = 1;
  const itemsPerPage = 20;
  let currentGridData = [];
  let viewMode = "home";
  let currentModalProductId = null;

  document.addEventListener("DOMContentLoaded", () => {
    loadCart();
    setupMenu();
    setupEventListeners();
    setupModalBackdropClosing();

    // ç­‰å¾…æ•°æ®åŠ è½½
    const checkDataInterval = setInterval(() => {
      if (window.perfumeDB && window.perfumeDB.length > 0) {
        clearInterval(checkDataInterval);
        renderHome();
      }
    }, 50);
  });

  // --- è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å®¹é‡ (ML -> FL OZ) ---
  // å‡è®¾æ‚¨çš„è¡¨æ ¼åˆ—åæ˜¯ 'ml'ï¼Œå¦‚æœæ˜¯å…¶ä»–åå­—è¯·åœ¨è¿™é‡Œä¿®æ”¹
  function formatSize(item) {
    if (!item.ml) return "";
    const ml = parseInt(item.ml);
    if (isNaN(ml)) return item.ml; // å¦‚æœä¸æ˜¯æ•°å­—ï¼Œç›´æ¥æ˜¾ç¤º
    const flOz = (ml / 29.57).toFixed(1); // è‡ªåŠ¨æ¢ç®—
    return `${ml}ml <span style="color:#999;font-weight:normal">(${flOz} oz)</span>`;
  }

  // --- 1. é¦–é¡µæ¸²æŸ“ ---
  function renderHome() {
    const db = (window.perfumeDB || []).filter((p) => parseInt(p.stock) !== 0);
    const container = document.getElementById("home-content");
    container.innerHTML = "";

    // 1. Best Sellers
    const bestSellers = db.filter((p) => p.top == 1);
    if (bestSellers.length > 0) {
      container.appendChild(createBrandSection("ğŸ”¥ Best Sellers", bestSellers));
    }

    // 2. Featured Brands
    const renderedBrands = new Set();
    FEATURED_BRANDS.forEach((brand) => {
      const products = db.filter((p) =>
        p.brand.toLowerCase().includes(brand.toLowerCase())
      );
      if (products.length >= 3) {
        let displayName = brand === "Yves Saint Laurent" ? "YSL" : brand;
        container.appendChild(createBrandSection(displayName, products, brand));
        renderedBrands.add(brand);
      }
    });

    // 3. Other Brands
    const otherProducts = db.filter((p) => {
      for (let featured of renderedBrands) {
        if (p.brand.toLowerCase().includes(featured.toLowerCase()))
          return false;
      }
      return true;
    });

    if (otherProducts.length > 0) {
      container.appendChild(
        createBrandSection("Other Brands", otherProducts, "Other")
      );
    }

    // 4. Shop All Button
    const shopAllContainer = document.createElement("div");
    shopAllContainer.className = "shop-all-section";
    shopAllContainer.innerHTML = `
            <button class="shop-all-btn" onclick="handleMenuClick('All')">Shop All Products</button>
        `;
    container.appendChild(shopAllContainer);
  }

  function createBrandSection(title, products, filterKey) {
    const section = document.createElement("div");
    section.className = "brand-section";

    const header = document.createElement("div");
    header.className = "brand-header";
    header.innerHTML = `
            <h2 class="brand-title">${title}</h2>
            <div class="brand-see-all" onclick="switchToGrid('${
              filterKey || (title.includes("Best") ? "BestSellers" : "All")
            }')">See All ></div>
        `;
    section.appendChild(header);

    const wrapper = document.createElement("div");
    wrapper.className = "scroll-wrapper";

    // åªæ˜¾ç¤ºå‰ 15 ä¸ª
    products.slice(0, 15).forEach((p) => {
      const card = document.createElement("div");
      card.className = "scroll-card";
      card.onclick = (e) => {
        if (e.target.classList.contains("scroll-card-add")) return;
        openModal(p);
      };

      // --- å…³é”®ä¿®æ”¹ï¼šåŠ å…¥ ID å’Œ å®¹é‡æ˜¾ç¤º ---
      card.innerHTML = `
            <div style="position:relative;">
               <img src="${p.img}" loading="lazy" alt="${p.name}">
               ${p.top == 1 ? '<div class="tag-hot">HOT</div>' : ""}
            </div>
            <div class="scroll-card-title">${p.name}</div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <span class="scroll-card-sub" style="margin:0;">${
                  p.brand
                }</span>
                <span style="font-size:0.7rem; color:#aaa;">#${
                  p.id || ""
                }</span>
            </div>

            <div class="scroll-card-price">
                $${p.price} 
                <span style="font-size:0.75rem; color:#666; font-weight:normal; margin-left:5px;">
                    ${p.ml ? p.ml + "ml" : ""}
                </span>
            </div>
            
            <div class="scroll-card-add" onclick="addToCart('${
              p.id
            }'); event.stopPropagation();">Add To Cart</div>
          `;
      wrapper.appendChild(card);
    });

    section.appendChild(wrapper);
    return section;
  }

  // --- 2. Grid æ¸²æŸ“ (æŸ¥çœ‹å…¨éƒ¨é¡µ) ---
  function switchToGrid(criteria) {
    viewMode = "grid";
    document.getElementById("home-view").style.display = "none";
    document.getElementById("grid-view").style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });

    const db = (window.perfumeDB || []).filter((p) => parseInt(p.stock) !== 0);
    let filtered = [];
    let title = "";

    // æœç´¢ä¸ç­›é€‰é€»è¾‘
    if (criteria === "All") {
      filtered = db;
      title = "All Products";
    } else if (criteria === "BestSellers") {
      filtered = db.filter((p) => p.top == 1);
      title = "Best Sellers";
    } else if (criteria.startsWith("Search:")) {
      const term = criteria.replace("Search:", "").toLowerCase();
      filtered = db.filter(
        (p) =>
          p.name.toLowerCase().includes(term) ||
          p.brand.toLowerCase().includes(term) ||
          (p.id && p.id.toString().includes(term))
      );
      title = `Results: "${term}"`;
    } else if (criteria === "Other") {
      // ç®€åŒ–çš„ Other é€»è¾‘
      filtered = db;
      title = "More Brands";
    } else {
      filtered = db.filter((p) => p.brand.includes(criteria));
      title = criteria;
    }

    document.getElementById("grid-title").textContent = title;
    currentGridData = filtered;
    currentPage = 1;
    renderGridPage();
  }

  function renderGridPage() {
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";
    const controls = document.getElementById("pagination-controls");

    if (currentGridData.length === 0) {
      gallery.innerHTML =
        "<div style='grid-column:1/-1;text-align:center;padding:50px;color:#999;'>No items found.</div>";
      controls.style.display = "none";
      return;
    }

    const start = (currentPage - 1) * itemsPerPage;
    const pageItems = currentGridData.slice(start, start + itemsPerPage);

    pageItems.forEach((p) => {
      const div = document.createElement("div");
      div.className = "item";
      // --- Grid è§†å›¾ä¹ŸåŠ å…¥ ID å’Œ ML ---
      div.innerHTML = `
              <div style="position:relative">
                  <img src="${p.img}" loading="lazy" onclick="openModalById('${
        p.id
      }')">
                  <div style="position:absolute; bottom:5px; right:5px; background:rgba(255,255,255,0.9); padding:2px 6px; font-size:0.7rem; border-radius:4px; color:#555;">
                    #${p.id}
                  </div>
              </div>
              <div class="caption">
                 <div style="font-size:0.85rem; height:2.4em; overflow:hidden; margin-bottom:5px; line-height:1.2;">${
                   p.name
                 }</div>
                 <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">${formatSize(
                   p
                 )}</div>
                 <div class="item-price">$${p.price}</div>
                 <button class="grid-add-btn" onclick="addToCart('${
                   p.id
                 }')">ADD TO CART</button>
              </div>
           `;
      gallery.appendChild(div);
    });

    // ç¿»é¡µé€»è¾‘
    const totalPages = Math.ceil(currentGridData.length / itemsPerPage);
    controls.style.display = totalPages > 1 ? "flex" : "none";
    if (totalPages > 1) {
      document.getElementById(
        "page-info"
      ).textContent = `${currentPage} / ${totalPages}`;
      document.getElementById("prev-page").disabled = currentPage === 1;
      document.getElementById("next-page").disabled =
        currentPage === totalPages;
    }
  }

  // --- 3. å¼¹çª—é€»è¾‘ (Modal) ---
  window.openModal = function (product) {
    currentModalProductId = product.id;
    document.getElementById("modal-img").src = product.img;
    document.getElementById("modal-title").textContent = product.name;

    // --- å¼¹çª—æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ ---
    // æ˜¾ç¤º: Brand | ID | Size
    document.getElementById("modal-sub").innerHTML = `
            <div>${product.brand}</div>
            <div style="margin-top:5px; font-size:0.9rem; color:#555;">
                ID: ${product.id} &nbsp;|&nbsp; Size: ${formatSize(product)}
            </div>
        `;

    document.getElementById("modal-price").textContent = "$" + product.price;
    updateModalButtonState(product.id);
    document.getElementById("modal").classList.add("open");
  };

  window.openModalById = function (id) {
    const p = window.perfumeDB.find((x) => x.id === id);
    if (p) openModal(p);
  };

  // --- 4. å…¶ä»–é€šç”¨åŠŸèƒ½ (èœå•, è´­ç‰©è½¦, Lightbox) ---
  window.handleMenuClick = function (action) {
    document.getElementById("sidebar").classList.remove("active");
    document.getElementById("sidebar-overlay").classList.remove("active");
    if (action === "Home") {
      viewMode = "home";
      document.getElementById("home-view").style.display = "block";
      document.getElementById("grid-view").style.display = "none";
      window.scrollTo({ top: 0 });
    } else {
      switchToGrid(action);
    }
  };

  function setupEventListeners() {
    const searchInput = document.getElementById("sidebar-search-input");
    searchInput.addEventListener("change", (e) => {
      if (e.target.value.trim()) {
        // ä¹Ÿå¯ä»¥æœ ID äº†
        document.getElementById("sidebar").classList.remove("active");
        document.getElementById("sidebar-overlay").classList.remove("active");
        switchToGrid("Search:" + e.target.value.trim());
        e.target.value = "";
      }
    });
    document.getElementById("prev-page").onclick = () => {
      currentPage--;
      renderGridPage();
      window.scrollTo(0, 0);
    };
    document.getElementById("next-page").onclick = () => {
      currentPage++;
      renderGridPage();
      window.scrollTo(0, 0);
    };
  }

  function setupMenu() {
    const trigger = document.getElementById("menu-trigger");
    const overlay = document.getElementById("sidebar-overlay");
    const sidebar = document.getElementById("sidebar");
    function toggle() {
      sidebar.classList.toggle("active");
      overlay.classList.toggle("active");
    }
    trigger.onclick = toggle;
    overlay.onclick = toggle;
  }

  window.addToCart = function (id) {
    const db = window.perfumeDB;
    const product = db.find((p) => p.id === id);
    if (!product) return;
    const existing = cartItems.find((c) => c.name === id);
    if (existing) {
      existing.quantity++;
    } else {
      cartItems.push({
        name: id,
        caption: `${id} - ${product.name} (${product.ml}ml)`, // è´­ç‰©è½¦ä¹Ÿå¸¦ä¸Šml
        img: product.img,
        price: Number(product.price),
        brand: product.brand,
        ml: product.ml,
        quantity: 1,
      });
    }
    saveCart();
    showToast("Added to Cart! ğŸ›’");
    if (currentModalProductId === id) updateModalButtonState(id);
  };

  function updateModalButtonState(id) {
    const container = document.getElementById("modal-action-area");
    const existing = cartItems.find((c) => c.name === id);
    if (!existing || existing.quantity === 0) {
      container.innerHTML = `<button class="modal-btn" onclick="modalFirstAdd('${id}')">ADD TO CART</button>`;
    } else {
      container.innerHTML = `
                <div class="qty-control-box">
                    <div class="qty-btn" onclick="modalChangeQty('${id}', -1)">-</div>
                    <div class="qty-val">${existing.quantity}</div>
                    <div class="qty-btn" onclick="modalChangeQty('${id}', 1)">+</div>
                </div>`;
    }
  }

  window.modalFirstAdd = (id) => addToCart(id);
  window.modalChangeQty = (id, delta) => {
    const existing = cartItems.find((c) => c.name === id);
    if (existing) {
      existing.quantity += delta;
      if (existing.quantity <= 0)
        cartItems = cartItems.filter((c) => c.name !== id);
      saveCart();
      updateModalButtonState(id);
    }
  };

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }
  function loadCart() {
    cartItems = JSON.parse(localStorage.getItem("perfumeCart") || "[]");
    updateCartCount();
  }
  function saveCart() {
    localStorage.setItem("perfumeCart", JSON.stringify(cartItems));
    updateCartCount();
  }
  function updateCartCount() {
    document.getElementById("header-cart-count").textContent = cartItems.reduce(
      (s, i) => s + i.quantity,
      0
    );
  }
  function setupModalBackdropClosing() {
    document.querySelectorAll(".modal, .lightbox").forEach((o) =>
      o.addEventListener("click", (e) => {
        if (e.target === o) {
          o.classList.remove("open");
          currentModalProductId = null;
        }
      })
    );
  }
</script>
