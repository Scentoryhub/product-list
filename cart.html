<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Your Cart</title>
    <style>
      /* Reset and common styles, similar to index.html */
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #f4f4f4;
        color: #111;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        position: relative;
        min-height: 100vh;
        /* 为固定底栏留出空间，防止内容被遮挡 */
        padding-bottom: 120px;
      }
      .page-header {
        position: relative;
        text-align: center;
        padding: 20px 15px;
        border-bottom: 1px solid #eee;
        background-color: #fff;
        margin-bottom: 20px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: 2px;
        color: #222;
      }
      .back-btn {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        cursor: pointer;
        text-decoration: none;
        transition: transform 0.3s;
        background-image: url("icon/back.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border: none;
        background-color: transparent;
      }
      .back-btn:hover {
        transform: translateY(-50%) scale(1.1);
      }
      .cart-container {
        max-width: 1200px; /* 稍微加宽以容纳三列 */
        margin: 0 auto;
        padding: 0 15px;
      }
      .cart-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        /* 默认设置为单排布局 */
        grid-template-columns: 1fr;
        gap: 15px;
      }

      /* 规则1: 超过6个商品，在平板及以上设备变为双排 */
      .cart-items-list.two-columns {
        @media (min-width: 768px) {
          grid-template-columns: 1fr 1fr;
        }
      }

      /* 规则2: 超过12个商品，在桌面设备变为三排 */
      .cart-items-list.three-columns {
        @media (min-width: 1024px) {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }

      .cart-item {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.2s ease-in-out;
        gap: 15px;
        padding-right: 15px;
      }
      .cart-item:hover {
        transform: translateY(-3px);
      }
      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        flex-shrink: 0;
      }
      .item-details {
        flex-grow: 1;
        padding: 15px 0;
      }
      .item-details h3 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        color: #333;
      }
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 5px;
      }
      .quantity-control button {
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .quantity-control button:hover {
        background: #ddd;
      }
      .quantity-control span {
        font-size: 1rem;
        font-weight: bold;
      }
      .cart-item .remove-btn {
        margin-left: auto;
      }
      .remove-btn {
        padding: 6px 10px;
        background: #eee;
        color: #777;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        font-size: 0.8rem;
      }
      .remove-btn:hover {
        background: #e74c3c;
        color: #fff;
      }
      .empty-cart-message {
        text-align: center;
        color: #777;
        font-size: 1.1rem;
        padding: 50px 0;
      }
      .cart-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        padding: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #eee;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        z-index: 10;
      }
      .cart-actions button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background-color 0.2s, transform 0.2s;
        flex-grow: 1;
        max-width: 200px;
      }
      .cart-actions button:hover {
        transform: translateY(-2px);
      }
      .clear-cart-btn {
        background-color: #e7e7e7;
        color: #555;
      }
      .clear-cart-btn:hover {
        background-color: #e74c3c;
        color: #fff;
      }
      .send-whatsapp-btn {
        background-color: #25d366;
        color: white;
      }
      .send-whatsapp-btn:hover {
        background-color: #1da851;
      }
      .cart-summary {
        max-width: 1200px;
        margin: 20px auto 0;
        padding: 15px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .cart-summary p {
        margin: 5px 0;
        font-size: 1rem;
        color: #333;
      }
      .cart-summary .total-count {
        font-weight: bold;
        color: #222;
        font-size: 1.1rem;
      }

      @media (min-width: 600px) {
        .cart-item img {
          width: 120px;
          height: 120px;
        }
      }
    </style>
  </head>
  <body>
    <header class="page-header">
      <a href="index.html" class="back-btn" aria-label="Go back"></a>
      <h1>Your Cart</h1>
    </header>

    <div class="cart-container">
      <ul id="cart-items-list" class="cart-items-list"></ul>
    </div>

    <div id="cart-summary" class="cart-summary">
      <p id="total-count" class="total-count">总数量: 0</p>
      <p id="lv-count">LV 数量: 0</p>
      <p id="other-brands-count">其他品牌数量: 0</p>
    </div>

    <div class="cart-actions">
      <button id="clear-cart-btn" class="clear-cart-btn">Clear Cart</button>
      <button id="send-whatsapp-btn" class="send-whatsapp-btn">
        Send on WhatsApp
      </button>
    </div>

    <script>
      const cartItemsList = document.getElementById("cart-items-list");
      const clearCartBtn = document.getElementById("clear-cart-btn");
      const sendWhatsappBtn = document.getElementById("send-whatsapp-btn");
      const totalCountEl = document.getElementById("total-count");
      const lvCountEl = document.getElementById("lv-count");
      const otherBrandsCountEl = document.getElementById("other-brands-count");

      const whatsappNumber = "16232027321";

      // --- 新增: 品牌列表，用于从长标题中提取品牌名 ---
      const BRANDS = [
        "Dior",
        "Chanel",
        "Yves Saint Laurent",
        "Louis Vuitton",
        "Tom Ford",
        "Gucci",
        "Valentino",
        "Prada",
        "Versace",
        "Creed",
        "Jean Paul Gaultier",
        "Maison Francis Kurkdjian",
        "Parfums de Marly",
        "Giorgio Armani",
        "Carolina Herrera",
        "Lancôme",
        "Paco Rabanne",
        "Xerjoff",
        "Initio",
        "Lattafa",
        "Ralph Lauren",
        "Burberry",
        "Le Labo",
        "Hugo Boss",
        "Hermès",
        "Byredo",
        "Jo Malone",
        // 如果有其他品牌，可以继续添加
      ];

      function loadCartFromLocalStorage() {
        const storedCart = localStorage.getItem("cartItems");
        return storedCart ? JSON.parse(storedCart) : [];
      }

      function saveCartToLocalStorage(cart) {
        localStorage.setItem("cartItems", JSON.stringify(cart));
      }

      // --- 新增: 从完整标题生成短标题的函数 ---
      function getShortCaption(fullCaption) {
        const captionParts = fullCaption.split(" - ");
        if (captionParts.length < 2) {
          return fullCaption; // 如果格式不符，返回原始标题
        }
        const itemNumber = captionParts[0];
        const fullName = captionParts.slice(1).join(" - ");

        // 查找哪个品牌名包含在完整名称中
        const foundBrand = BRANDS.find((brand) =>
          fullName.toLowerCase().includes(brand.toLowerCase())
        );

        if (foundBrand) {
          return `${itemNumber} - ${foundBrand}`;
        }

        // 如果在列表中找不到品牌，返回原始标题作为备用
        return fullCaption;
      }

      function renderCartItems() {
        let cartItems = loadCartFromLocalStorage();
        cartItemsList.innerHTML = "";

        cartItemsList.classList.remove("two-columns", "three-columns");
        const itemCount = cartItems.length;
        if (itemCount > 12) {
          cartItemsList.classList.add("three-columns");
        } else if (itemCount > 6) {
          cartItemsList.classList.add("two-columns");
        }

        if (cartItems.length === 0) {
          cartItemsList.innerHTML =
            "<p class='empty-cart-message'>Your cart is empty.</p>";
        } else {
          cartItems.sort((a, b) => {
            const getNumber = (str) =>
              parseInt(str.match(/\d+/)?.[0] || "0", 10);
            const numA = getNumber(a.caption);
            const numB = getNumber(b.caption);
            return numA - numB;
          });

          cartItems.forEach((item, index) => {
            const li = document.createElement("li");
            li.className = "cart-item";

            // --- 核心改动: 使用 getShortCaption 函数处理标题 ---
            const displayCaption = getShortCaption(item.caption);

            li.innerHTML = `
              <img src="${item.img}" alt="${item.name}" loading="lazy">
              <div class="item-details">
                <h3>${displayCaption}</h3>
                <div class="quantity-control">
                  <button class="decrease-quantity" data-index="${index}">-</button>
                  <span>${item.quantity}</span>
                  <button class="increase-quantity" data-index="${index}">+</button>
                </div>
              </div>
              <button class="remove-btn" data-index="${index}">Remove</button>
            `;
            cartItemsList.appendChild(li);
          });
        }
        updateCartSummary();
      }

      function updateCartSummary() {
        let cartItems = loadCartFromLocalStorage();
        let totalCount = 0;
        let lvCount = 0;
        let otherBrandsCount = 0;

        cartItems.forEach((item) => {
          totalCount += item.quantity;
          if (item.caption.toLowerCase().includes("louis vuitton")) {
            lvCount += item.quantity;
          } else {
            otherBrandsCount += item.quantity;
          }
        });

        totalCountEl.textContent = `Total Quantity: ${totalCount}`;
        lvCountEl.textContent = `LV Quantity: ${lvCount}`;
        otherBrandsCountEl.textContent = `Other Quantity: ${otherBrandsCount}`;

        return { totalCount, lvCount, otherBrandsCount };
      }

      function updateQuantity(index, change) {
        let cartItems = loadCartFromLocalStorage();
        const sortedItems = [...cartItems].sort((a, b) => {
          const getNumber = (str) => parseInt(str.match(/\d+/)?.[0] || "0", 10);
          const numA = getNumber(a.caption);
          const numB = getNumber(b.caption);
          return numA - numB;
        });

        const itemToUpdate = sortedItems[index];

        if (itemToUpdate) {
          itemToUpdate.quantity = Math.max(0, itemToUpdate.quantity + change);
          const originalItemIndex = cartItems.findIndex(
            (item) => item.caption === itemToUpdate.caption
          );
          if (originalItemIndex !== -1) {
            cartItems[originalItemIndex].quantity = itemToUpdate.quantity;
          }
          const updatedCart = cartItems.filter((item) => item.quantity > 0);
          saveCartToLocalStorage(updatedCart);
          renderCartItems();
          updateMainPageCartCount();
        }
      }

      function updateMainPageCartCount() {
        if (window.opener) {
          window.opener.postMessage("updateCartCount", "*");
        }
      }

      document.addEventListener("DOMContentLoaded", renderCartItems);

      cartItemsList.addEventListener("click", (e) => {
        const index = e.target.getAttribute("data-index");
        if (index === null) return;

        if (e.target.classList.contains("remove-btn")) {
          if (!confirm("Are you sure you want to remove this item?")) {
            return;
          }

          let cartItems = loadCartFromLocalStorage();
          const sortedItems = [...cartItems].sort((a, b) => {
            const getNumber = (str) =>
              parseInt(str.match(/\d+/)?.[0] || "0", 10);
            const numA = getNumber(a.caption);
            const numB = getNumber(b.caption);
            return numA - numB;
          });
          const itemToRemove = sortedItems[index];

          if (itemToRemove) {
            const updatedCart = cartItems.filter(
              (item) => item.caption !== itemToRemove.caption
            );
            saveCartToLocalStorage(updatedCart);
            renderCartItems();
            updateMainPageCartCount();
          }
        } else if (e.target.classList.contains("increase-quantity")) {
          updateQuantity(parseInt(index), 1);
        } else if (e.target.classList.contains("decrease-quantity")) {
          updateQuantity(parseInt(index), -1);
        }
      });

      clearCartBtn.addEventListener("click", () => {
        if (!confirm("Are you sure you want to clear your cart?")) {
          return;
        }
        localStorage.removeItem("cartItems");
        renderCartItems();
        updateMainPageCartCount();
      });

      sendWhatsappBtn.addEventListener("click", () => {
        const cartItems = loadCartFromLocalStorage();
        if (cartItems.length === 0) {
          alert(
            "Your cart is empty. Please add items before sending an order."
          );
          return;
        }

        const originalText = sendWhatsappBtn.textContent;
        sendWhatsappBtn.textContent = "准备中...";
        sendWhatsappBtn.disabled = true;
        sendWhatsappBtn.style.backgroundColor = "#1da851";

        const summary = updateCartSummary();
        cartItems.sort((a, b) => {
          const getNumber = (str) => parseInt(str.match(/\d+/)?.[0] || "0", 10);
          const numA = getNumber(a.caption);
          const numB = getNumber(b.caption);
          return numA - numB;
        });

        // WhatsApp 消息仍然使用完整的 item.caption
        const messageLines = cartItems.map(
          (item) => `* ${item.caption} (${item.quantity} bottles)`
        );

        const summaryLines = [
          `Total: ${summary.totalCount} bottles`,
          `LV: ${summary.lvCount} bottles`,
          `Other Brands: ${summary.otherBrandsCount} bottles`,
        ];

        const message = `Hello, I am interested in the following perfumes:%0A${messageLines.join(
          "%0A"
        )}%0A%0A---%0A*Order Summary*%0A${summaryLines.join(
          "%0A"
        )}%0A%0APlease provide a quote. Thank you!`;

        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
        window.open(whatsappUrl, "_blank");

        setTimeout(() => {
          sendWhatsappBtn.textContent = originalText;
          sendWhatsappBtn.disabled = false;
          sendWhatsappBtn.style.backgroundColor = "#25d366";
        }, 1000);
      });
    </script>
  </body>
</html>
